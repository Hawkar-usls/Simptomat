<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SYMPTOMA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-void:#050a10; --c-main:#00f2ff; --c-dim:#005f66; --c-alert:#ff3366; --font-header:'Roboto Mono',monospace; --font-body:'Lato',sans-serif; }
        body,html{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background-color:var(--bg-void);font-family:var(--font-body);color:var(--c-main);}
        #grid{position:absolute;width:200%;height:200%;background-image:linear-gradient(var(--c-dim) 1px,transparent 1px),linear-gradient(90deg,var(--c-dim) 1px,transparent 1px);background-size:40px 40px;opacity:0.1;transform:perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px);animation:gridMove 20s linear infinite;pointer-events:none;}
        @keyframes gridMove{0%{transform:perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px);}100%{transform:perspective(500px) rotateX(60deg) translateY(40px) translateZ(-200px);}}
        .ui-layer{position:absolute;width:100%;height:100%;z-index:20;display:flex;flex-direction:column;}
        .header-row{display:flex;justify-content:space-between;padding:15px 20px;background:rgba(5,10,16,0.9);border-bottom:1px solid var(--c-dim);}
        #chat-window{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:15px;}
        .msg{max-width:85%;padding:12px;border-radius:8px;font-size:0.95rem;word-wrap:break-word;}
        .msg.bot{align-self:flex-start;background:rgba(11,20,30,0.9);border-left:3px solid var(--c-main);color:#e0f7fa;}
        .msg.user{align-self:flex-end;background:rgba(0,242,255,0.05);text-align:right;}
        .msg.diagnosis{align-self:flex-start;border-left:3px solid var(--c-alert);background:rgba(255,51,102,0.05);}
        #controls{display:flex;gap:10px;padding:15px;background:var(--bg-panel);border-top:1px solid var(--c-dim);}
        input{flex:1;background:#050a10;border:1px solid var(--c-dim);color:var(--c-main);padding:12px;border-radius:6px;outline:none;}
        input:disabled{opacity: 0.5;}
        #send-btn{background:var(--c-dim);color:#fff;border:none;padding:0 20px;border-radius:6px;font-weight:bold;}
        #send-btn:disabled{opacity: 0.5; filter: grayscale(1);}
    </style>
</head>
<body>
    <div id="grid"></div>
    <div class="ui-layer">
        <div class="header-row">
            <div style="font-weight:bold; font-family:var(--font-header);">SYMPTOMA</div>
            <div id="status" style="font-size:0.8rem; color:#aaa;">INIT</div>
        </div>
        <div id="chat-window"></div>
        <div id="controls">
            <input type="text" id="user-input" placeholder="..." autocomplete="off">
            <button id="send-btn" onclick="sendMessage()">SEND</button>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // === COURT ORDER: DYNAMIC URL RESOLUTION ===
    function getApiUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        // Приоритет: 1. Параметр из URL (от бота) 2. Дефолт (на всякий случай)
        return urlParams.get('apiUrl') || "https://supperless-yoshiko-noneruditely.ngrok-free.dev";
    }

    const API_BASE = getApiUrl();
    document.getElementById('status').innerText = API_BASE.includes("ngrok") ? "SECURE TUNNEL" : "LOCAL/STATIC";

    const API_HEADERS = { 
        'Content-Type': 'application/json',
        'ngrok-skip-browser-warning': 'true'
    };

    // Client history is ONLY for display now. Server has the real brain.
    let displayHistory = [];

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const btn = document.getElementById('send-btn');
        const text = input.value.trim();
        
        if(!text) return;

        // UI LOCK
        input.disabled = true;
        btn.disabled = true;
        
        // 1. Show User Message (Safe render)
        appendMsg(text, 'user');
        input.value = '';

        // 2. Loading State
        const loadId = appendMsg("JANUS ANALYZING...", 'bot');

        try {
            const userId = tg.initDataUnsafe?.user?.id || 12345;
            
            // COURT ORDER: Sending Only UserID + Message (No History Blob)
            const res = await fetch(`${API_BASE}/api/symptoma/chat`, {
                method: 'POST',
                headers: API_HEADERS,
                body: JSON.stringify({ 
                    user_id: userId, 
                    message: text
                })
            });

            if(!res.ok) throw new Error(`HTTP ${res.status}`);
            
            const data = await res.json();
            
            // Remove Loader
            document.getElementById(loadId).remove();
            
            // Show AI Response
            const type = data.type === 'diagnosis' ? 'diagnosis' : 'bot';
            appendMsg(data.text, type);

        } catch(e) {
            console.error(e);
            document.getElementById(loadId).innerText = "CONNECTION ERROR. TRY RESTARTING.";
            document.getElementById(loadId).style.color = "var(--c-alert)";
        } finally {
            // UI UNLOCK
            input.disabled = false;
            btn.disabled = false;
            input.focus();
        }
    }

    function appendMsg(text, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        
        // SECURITY: User text is plain text, Bot text can be HTML
        if (type === 'user') div.innerText = text;
        else div.innerHTML = text; // Bot uses HTML for formatting
        
        const chat = document.getElementById('chat-window');
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
        return 'msg-' + Date.now();
    }

    // Enter Key Support
    document.getElementById('user-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    appendMsg("SYSTEM ONLINE. DESCRIBE SYMPTOMS.", "bot");
</script>
</body>
</html>
