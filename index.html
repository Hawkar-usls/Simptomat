<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SYMPTOMA: NGROK EDITION</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-void:#050a10; --c-main:#00f2ff; --c-dim:#005f66; --c-alert:#ff3366; --font-header:'Roboto Mono',monospace; --font-body:'Lato',sans-serif; }
        body,html{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background-color:var(--bg-void);font-family:var(--font-body);color:var(--c-main);}
        #grid{position:absolute;width:200%;height:200%;background-image:linear-gradient(var(--c-dim) 1px,transparent 1px),linear-gradient(90deg,var(--c-dim) 1px,transparent 1px);background-size:40px 40px;opacity:0.1;transform:perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px);animation:gridMove 20s linear infinite;pointer-events:none;}
        @keyframes gridMove{0%{transform:perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px);}100%{transform:perspective(500px) rotateX(60deg) translateY(40px) translateZ(-200px);}}
        .ui-layer{position:absolute;width:100%;height:100%;z-index:20;display:flex;flex-direction:column;}
        .header-row{display:flex;justify-content:space-between;padding:15px 20px;background:rgba(5,10,16,0.9);border-bottom:1px solid var(--c-dim);}
        #logo{font-family:var(--font-header);font-size:1.2rem;font-weight:700;}
        #lang-btn{background:rgba(0,242,255,0.1);border:1px solid var(--c-dim);color:var(--c-main);padding:5px 10px;border-radius:5px;}
        #chat-window{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:15px;}
        .msg{max-width:85%;padding:12px;border-radius:8px;font-size:0.95rem;}
        .msg.bot{align-self:flex-start;background:rgba(11,20,30,0.9);border-left:3px solid var(--c-main);color:#e0f7fa;}
        .msg.user{align-self:flex-end;background:rgba(0,242,255,0.05);text-align:right;}
        .msg.diagnosis{align-self:flex-start;border-left:3px solid var(--c-alert);background:rgba(255,51,102,0.05);}
        #controls{display:flex;gap:10px;padding:15px;background:var(--bg-panel);border-top:1px solid var(--c-dim);}
        input{flex:1;background:#050a10;border:1px solid var(--c-dim);color:var(--c-main);padding:12px;border-radius:6px;outline:none;}
        #send-btn{background:var(--c-dim);color:#fff;border:none;padding:0 20px;border-radius:6px;font-weight:bold;}
    </style>
</head>
<body>
    <div id="grid"></div>
    <div class="ui-layer">
        <div class="header-row">
            <div id="logo">SYMPTOMA</div>
            <button id="lang-btn" onclick="alert('Switching Lang...')">RU</button>
        </div>
        <div id="chat-window"></div>
        <div id="controls">
            <input type="text" id="user-input" placeholder="..." autocomplete="off">
            <button id="send-btn" onclick="sendMessage()">SEND</button>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // =========================================================
    // ⚙️ NGROK URL
    // =========================================================
    const NGROK_URL = "https://supperless-yoshiko-noneruditely.ngrok-free.dev"; 
    // =========================================================

    // Headers required for Ngrok free tier
    const API_HEADERS = { 
        'Content-Type': 'application/json',
        'ngrok-skip-browser-warning': 'true'
    };

    let history = [];

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if(!text) return;

        appendMsg(text, 'user');
        input.value = '';
        history.push({text: text, is_bot: false});

        const loadId = appendMsg("JANUS ANALYZING...", 'bot');

        try {
            const userId = tg.initDataUnsafe?.user?.id || 12345;
            
            const res = await fetch(`${NGROK_URL}/api/symptoma/chat`, {
                method: 'POST',
                headers: API_HEADERS,
                body: JSON.stringify({ 
                    user_id: userId, 
                    message: text, 
                    history: history 
                })
            });

            if(!res.ok) throw new Error("Network Error");
            
            const data = await res.json();
            document.getElementById(loadId).remove();
            
            const type = data.type === 'diagnosis' ? 'diagnosis' : 'bot';
            appendMsg(data.text, type);
            history.push({text: data.text, is_bot: true});

        } catch(e) {
            console.error(e);
            document.getElementById(loadId).innerText = "JANUS OFFLINE (CHECK NGROK)";
        }
    }

    function appendMsg(text, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerHTML = text;
        const chat = document.getElementById('chat-window');
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
        return 'msg-' + Date.now();
    }

    appendMsg("SYSTEM ONLINE. DESCRIBE SYMPTOMS.", "bot");
</script>
</body>
</html>
