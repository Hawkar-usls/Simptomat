<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SYMPTOMA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-void:#050a10; --c-main:#00f2ff; --c-dim:#005f66; --c-alert:#ff3366; --font-header:'Roboto Mono',monospace; --font-body:'Lato',sans-serif; }
        body,html{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background-color:var(--bg-void);font-family:var(--font-body);color:var(--c-main);}
        #grid{position:absolute;width:200%;height:200%;background-image:linear-gradient(var(--c-dim) 1px,transparent 1px),linear-gradient(90deg,var(--c-dim) 1px,transparent 1px);background-size:40px 40px;opacity:0.1;transform:perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px);animation:gridMove 20s linear infinite;pointer-events:none;}
        @keyframes gridMove{0%{transform:perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px);}100%{transform:perspective(500px) rotateX(60deg) translateY(40px) translateZ(-200px);}}
        .ui-layer{position:absolute;width:100%;height:100%;z-index:20;display:flex;flex-direction:column;}
        .header-row{display:flex;justify-content:space-between;padding:15px 20px;background:rgba(5,10,16,0.9);border-bottom:1px solid var(--c-dim);}
        #chat-window{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:15px;scroll-behavior: smooth;}
        .msg{max-width:85%;padding:12px;border-radius:8px;font-size:0.95rem;word-wrap:break-word;line-height: 1.4;}
        .msg.bot{align-self:flex-start;background:rgba(11,20,30,0.9);border-left:3px solid var(--c-main);color:#e0f7fa;}
        .msg.user{align-self:flex-end;background:rgba(0,242,255,0.05);text-align:right;border-right: 3px solid var(--c-dim);}
        .msg.diagnosis{align-self:flex-start;border-left:3px solid var(--c-alert);background:rgba(255,51,102,0.05);}
        #controls{display:flex;gap:10px;padding:15px;background:var(--bg-void);border-top:1px solid var(--c-dim);padding-bottom: max(15px, env(safe-area-inset-bottom));}
        input{flex:1;background:#050a10;border:1px solid var(--c-dim);color:var(--c-main);padding:12px;border-radius:6px;outline:none;font-family: var(--font-body);}
        #send-btn{background:var(--c-dim);color:#fff;border:none;padding:0 20px;border-radius:6px;font-weight:bold;cursor: pointer;}
        #send-btn:active{transform: scale(0.95);}
    </style>
</head>
<body>
    <div id="grid"></div>
    <div class="ui-layer">
        <div class="header-row">
            <div style="font-weight:bold; font-family:var(--font-header);">SYMPTOMA</div>
            <div id="status" style="font-size:0.8rem; color:#aaa;">INIT</div>
        </div>
        <div id="chat-window"></div>
        <div id="controls">
            <input type="text" id="user-input" placeholder="Введите симптомы..." autocomplete="off">
            <button id="send-btn" onclick="sendMessage()">SEND</button>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.enableClosingConfirmation();

    // !!! ПРОВЕРЬ ССЫЛКУ NGROK !!!
    function getApiUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('apiUrl') || "https://supperless-yoshiko-noneruditely.ngrok-free.dev";
    }

    const API_BASE = getApiUrl();
    document.getElementById('status').innerText = API_BASE.includes("ngrok") ? "ONLINE" : "LOCAL";

    const API_HEADERS = { 
        'Content-Type': 'application/json',
        'ngrok-skip-browser-warning': 'true'
    };

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if(!text) return;

        // 1. Показываем сообщение пользователя
        appendMsg(text, 'user');
        input.value = '';

        // 2. Показываем "Анализирую..." и запоминаем ID этого сообщения
        const loadId = appendMsg("Анализирую...", 'bot');

        try {
            const userId = tg.initDataUnsafe?.user?.id || 12345;
            
            const res = await fetch(`${API_BASE}/api/symptoma/chat`, {
                method: 'POST', headers: API_HEADERS,
                body: JSON.stringify({ user_id: userId, message: text })
            });

            if(!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            
            // 3. Удаляем сообщение "Анализирую..." по ID
            const loader = document.getElementById(loadId);
            if (loader) loader.remove();

            // 4. Показываем настоящий ответ
            appendMsg(data.text, data.type === 'diagnosis' ? 'diagnosis' : 'bot');

        } catch(e) {
            console.error(e);
            const loader = document.getElementById(loadId);
            if (loader) loader.innerText = "Ошибка связи: " + e.message;
        }
    }

    function appendMsg(text, type) {
        const div = document.createElement('div');
        // Генерируем уникальный ID
        const id = 'msg-' + Date.now() + Math.random().toString(36).substr(2, 9);
        
        div.id = id; // <--- ВОТ ЭТОЙ СТРОКИ НЕ ХВАТАЛО
        div.className = `msg ${type}`;
        
        if (type === 'user') div.innerText = text; 
        else div.innerHTML = text.replace(/\n/g, '<br>'); // Сохраняем переносы строк от бота
        
        const chat = document.getElementById('chat-window');
        chat.appendChild(div);
        
        // Прокрутка вниз
        requestAnimationFrame(() => {
            chat.scrollTop = chat.scrollHeight;
        });
        
        return id;
    }

    document.getElementById('user-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    // START MESSAGE
    appendMsg("<b>СИСТЕМА ГОТОВА.</b><br>Я — диагностический модуль. Опишите, что вас беспокоит.", "bot");
</script>
</body>
</html>
