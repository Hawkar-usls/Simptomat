<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SYMPTOMA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            /* Palette: Sterile Medical / Sci-Fi */
            --bg-color: #0b1015;       
            --panel-bg: #0f161e;       
            --accent: #00f2ff;         
            --accent-dim: #005f66;     
            --text-main: #e0f7fa;      
            --alert: #ff3333;          
            --font-main: "Roboto Mono", "Consolas", monospace;
        }

        body { margin: 0; background: var(--bg-color); color: var(--text-main); font-family: var(--font-main); display: flex; flex-direction: column; height: 100vh; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        
        .header { padding: 15px; background: #080c10; border-bottom: 1px solid var(--accent-dim); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 0 10px rgba(0, 242, 255, 0.1); z-index: 10; }
        .brand { font-weight: 700; font-size: 1rem; letter-spacing: 1px; color: var(--accent); text-transform: uppercase; cursor: pointer; }
        .energy-box { border: 1px solid var(--accent-dim); padding: 4px 8px; font-size: 0.75rem; border-radius: 4px; color: var(--accent); cursor: pointer; transition: 0.2s; }
        .energy-box:active { background: var(--accent-dim); color: #fff; }
        
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 8px; font-size: 0.9rem; line-height: 1.5; position: relative; word-wrap: break-word; animation: fadeIn 0.3s ease; }
        .msg.bot { align-self: flex-start; background: var(--panel-bg); border-left: 3px solid var(--accent); color: #fff; }
        .msg.diagnosis { align-self: flex-start; border-left: 3px solid var(--alert); background: rgba(255, 51, 51, 0.05); color: #fff; }
        .msg.diagnosis b { color: var(--alert); }
        .msg.user { align-self: flex-end; background: rgba(0, 242, 255, 0.1); border: 1px solid var(--accent-dim); color: var(--accent); text-align: right; }

        .disclaimer { font-size: 0.6rem; color: #546e7a; text-align: center; padding: 8px; border-top: 1px solid #1a2633; text-transform: uppercase; }

        .input-area { padding: 15px; background: #080c10; border-top: 1px solid var(--accent-dim); display: flex; gap: 10px; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
        input { flex: 1; background: #0f161e; border: 1px solid var(--accent-dim); color: var(--accent); padding: 12px; font-family: var(--font-main); font-size: 1rem; outline: none; border-radius: 4px; }
        input:focus { border-color: var(--accent); box-shadow: 0 0 5px rgba(0,242,255,0.2); }
        button { background: var(--accent-dim); color: #fff; border: none; padding: 0 20px; font-weight: bold; cursor: pointer; font-family: var(--font-main); border-radius: 4px; transition: 0.2s; }
        button:active { background: var(--accent); color: #000; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-card { background: #080c10; border: 1px solid var(--accent); padding: 30px 20px; text-align: center; width: 85%; max-width: 340px; box-shadow: 0 0 30px rgba(0, 242, 255, 0.15); border-radius: 8px; }
        .modal-btn { background: var(--accent); color: #000; border: none; padding: 15px; width: 100%; font-family: var(--font-main); font-weight: 700; cursor: pointer; margin-top: 15px; border-radius: 4px; font-size: 1rem; text-transform: uppercase; }
        .modal-btn-close { background: transparent; color: #546e7a; border: 1px solid #1a2633; margin-top: 10px; font-size: 0.8rem; padding: 10px; }

        /* Lang Selector Styles */
        .lang-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px; }
        .lang-opt { background: #0f161e; border: 1px solid var(--accent-dim); color: var(--accent); padding: 8px 12px; cursor: pointer; font-size: 0.8rem; border-radius: 4px; }
        .lang-opt:hover { border-color: var(--accent); background: rgba(0, 242, 255, 0.1); }
        #lang-display { font-size: 0.8rem; opacity: 0.7; margin-left: 5px; cursor: pointer; border: 1px solid var(--accent-dim); padding: 2px 5px; border-radius: 3px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .loading { animation: pulse 1.5s infinite; color: var(--accent); font-style: italic; }
    </style>
</head>
<body>

<div class="header">
    <div class="brand">SYMPTOMA <span style="font-size:0.8em; opacity:0.7">v3.0</span> <span id="lang-display" onclick="openLangModal()">RU</span></div>
    <div class="energy-box" id="energy-display" onclick="openPaywall()">PWR: --%</div>
</div>

<div id="chat-container">
    </div>

<div class="disclaimer">Not a doctor. AI suggestions only. In emergency call 112/911.</div>

<div class="input-area">
    <input type="text" id="user-input" placeholder="..." autocomplete="off">
    <button id="send-btn" onclick="sendMessage()">SEND</button>
</div>

<div id="paywall-modal" class="modal-overlay">
    <div class="modal-card">
        <h3 id="lbl-pay-title" style="color: var(--accent); margin-top: 0;">ENERGY CRITICAL</h3>
        <p id="lbl-pay-desc" style="color: #b0bec5; font-size: 0.9rem; line-height: 1.5; margin-bottom: 20px;">Protocol requires power.</p>
        <button id="btn-pay" class="modal-btn" onclick="buyPremium()">GET ETERNAL (69 STARS)</button>
        <button id="btn-pay-later" class="modal-btn modal-btn-close" onclick="closePaywall()">LATER</button>
    </div>
</div>

<div id="lang-modal" class="modal-overlay" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-card">
        <h3 style="color: var(--accent); margin-top: 0;">LANGUAGE</h3>
        <div class="lang-list">
            <div class="lang-opt" onclick="setLang('en')">English</div>
            <div class="lang-opt" onclick="setLang('ru')">Русский</div>
            <div class="lang-opt" onclick="setLang('ua')">Українська</div>
            <div class="lang-opt" onclick="setLang('pl')">Polski</div>
            <div class="lang-opt" onclick="setLang('cz')">Čeština</div>
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    
    // !!! ОБЯЗАТЕЛЬНО ПРОВЕРЬ NGROK URL !!!
    const BACKEND_URL = "https://supperless-yoshiko-noneruditely.ngrok-free.dev"; 
    
    let history = [];
    let isProcessing = false;
    let isPremium = false;
    let energy = 0;
    let curLang = 'ru'; // Стандартно русский

    // СЛОВАРЬ (Твоя база)
    // SMM-тексты: вызывают доверие и заботу
    const DICT = {
        en: {
            welcome: "<b>SYSTEM ONLINE. v3.0</b><br>I am ready to analyze your condition.<br><br>Describe not just symptoms, but how you feel. I will provide a diagnosis and lifestyle correction tips.",
            placeholder: "Describe your condition...",
            send: "SEND",
            payTitle: "ENERGY LOW",
            payDesc: "Complete analysis requires energy. Invite friends or get Eternal access.",
            payBtn: "GET ETERNAL (69 ⭐️)",
            later: "LATER",
            error: "CONNECTION ERROR"
        },
        ru: {
            welcome: "<b>СИСТЕМА АКТИВНА. v3.0</b><br>Я готов к анализу вашего состояния.<br><br>Опишите симптомы. Я проведу диагностику, дам медицинский совет и рекомендации по улучшению качества жизни.",
            placeholder: "Опишите, что беспокоит...",
            send: "ОТПРАВИТЬ",
            payTitle: "МАЛО ЭНЕРГИИ",
            payDesc: "Для глубокого анализа нужна энергия. Пригласите друзей или получите Вечность.",
            payBtn: "ВЕЧНОСТЬ (69 ⭐️)",
            later: "ПОЗЖЕ",
            error: "ОШИБКА СВЯЗИ"
        },
        ua: {
            welcome: "<b>СИСТЕМА АКТИВНА. v3.0</b><br>Я готовий до аналізу.<br><br>Опишіть симптоми. Я проведу діагностику та дам поради щодо покращення життя і корекції звичок.",
            placeholder: "Опишіть, що турбує...",
            send: "НАДІСЛАТИ",
            payTitle: "МАЛО ЕНЕРГІЇ",
            payDesc: "Для аналізу потрібна енергія. Запросіть друзів або отримайте Вічність.",
            payBtn: "ВІЧНІСТЬ (69 ⭐️)",
            later: "ПІЗНІШЕ",
            error: "ПОМИЛКА ЗВ'ЯЗКУ"
        },
        pl: {
            welcome: "<b>SYSTEM ONLINE. v3.0</b><br>Gotowy do analizy.<br><br>Opisz objawy. Przeprowadzę diagnozę i udzielę porad dotyczących stylu życia.",
            placeholder: "Opisz swój stan...",
            send: "WYŚLIJ",
            payTitle: "MAŁO ENERGII",
            payDesc: "Analiza wymaga energii.",
            payBtn: "WIECZNOŚĆ (69 ⭐️)",
            later: "PÓŹNIEJ",
            error: "BŁĄD POŁĄCZENIA"
        },
        cz: {
            welcome: "<b>SYSTÉM ONLINE. v3.0</b><br>Připraven k analýze.<br><br>Popište příznaky. Poskytnu diagnózu a tipy pro úpravu životního stylu.",
            placeholder: "Popište svůj stav...",
            send: "ODESLAT",
            payTitle: "MÁLO ENERGIE",
            payDesc: "Analýza vyžaduje energii.",
            payBtn: "VĚČNOST (69 ⭐️)",
            later: "POZDĚJI",
            error: "CHYBA PŘIPOJENÍ"
        }
    };

    function updateTexts() {
        const t = DICT[curLang];
        document.getElementById('user-input').placeholder = t.placeholder;
        document.getElementById('send-btn').innerText = t.send;
        document.getElementById('lbl-pay-title').innerText = t.payTitle;
        document.getElementById('lbl-pay-desc').innerText = t.payDesc;
        document.getElementById('btn-pay').innerText = t.payBtn;
        document.getElementById('btn-pay-later').innerText = t.later;
        document.getElementById('lang-display').innerText = curLang.toUpperCase();
        
        // Обновляем приветствие только если чат пуст
        const container = document.getElementById('chat-container');
        if (container.children.length === 0) {
            appendMessage(t.welcome, 'bot');
        }
    }

    function setLang(lang) {
        curLang = lang;
        document.getElementById('lang-modal').style.display = 'none';
        // Очищаем чат при смене языка и показываем новое приветствие
        document.getElementById('chat-container').innerHTML = '';
        history = []; 
        updateTexts();
    }

    function openLangModal() { document.getElementById('lang-modal').style.display = 'flex'; }
    function openPaywall() { if (!isPremium) document.getElementById('paywall-modal').style.display = 'flex'; }
    function closePaywall() { document.getElementById('paywall-modal').style.display = 'none'; }

    async function syncEnergy() {
        const userId = tg.initDataUnsafe?.user?.id || 0;
        try {
            const res = await fetch(`${BACKEND_URL}/api/get_user_state?user_id=${userId}`);
            const data = await res.json();
            isPremium = data.is_premium;
            energy = data.energy;
            const txt = isPremium ? "\u221E" : energy + "%";
            const el = document.getElementById('energy-display');
            el.innerText = "PWR: " + txt;
            if (!isPremium && energy < 10) el.style.borderColor = "var(--alert)";
            else el.style.borderColor = "var(--accent-dim)";
        } catch(e) { console.log("Energy sync error.", e); }
    }

    async function buyPremium() {
        const userId = tg.initDataUnsafe?.user?.id || 0;
        const btn = document.getElementById('btn-pay');
        const oldText = btn.innerText;
        btn.innerText = "INITIALIZING...";
        try {
            const res = await fetch(`${BACKEND_URL}/api/get_invoice?app=symptoma`, { method: 'GET', headers: {'ngrok-skip-browser-warning': 'true'} });
            const data = await res.json();
            if (data.invoice_link) {
                tg.openInvoice(data.invoice_link, (status) => {
                    if (status === 'paid') {
                        isPremium = true;
                        closePaywall();
                        syncEnergy();
                        appendMessage("<b>SYSTEM UPGRADE:</b> Eternal Power Source Connected.", 'bot');
                    }
                });
            } else btn.innerText = "ERROR";
        } catch (e) { console.error(e); btn.innerText = "CONN ERROR"; } 
        finally { setTimeout(() => btn.innerText = oldText, 2000); }
    }

    setInterval(syncEnergy, 10000);
    syncEnergy();
    updateTexts(); // Инициализация текстов

    async function sendMessage() {
        if (isProcessing) return;
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text) return;

        if (!isPremium && energy < 25) { openPaywall(); return; }

        appendMessage(text, 'user');
        input.value = '';
        isProcessing = true;
        document.getElementById('send-btn').disabled = true;
        const loadingId = appendMessage("Scanning...", 'bot loading');

        try {
            const userId = tg.initDataUnsafe?.user?.id || 0;
            const res = await fetch(`${BACKEND_URL}/api/symptoma/chat`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
                body: JSON.stringify({ user_id: userId, message: text, history: history, lang: curLang }) // Передаем язык!
            });

            const loadingEl = document.getElementById(loadingId);
            if (res.status === 402) {
                loadingEl.remove(); openPaywall(); isProcessing = false; 
                document.getElementById('send-btn').disabled = false; return;
            }

            const data = await res.json();
            loadingEl.remove();

            if (data.error || data.type === 'error') {
                appendMessage("SYSTEM ERROR", 'bot');
            } else {
                const msgType = (data.type === 'diagnosis') ? 'diagnosis' : 'bot';
                appendMessage(data.text, msgType);
                history.push({text: text, is_bot: false});
                history.push({text: data.text, is_bot: true});
            }
        } catch (e) {
            document.getElementById(loadingId).innerText = DICT[curLang].error;
            document.getElementById(loadingId).classList.add('diagnosis');
        } finally {
            isProcessing = false;
            document.getElementById('send-btn').disabled = false;
            input.focus();
            syncEnergy(); 
        }
    }

    function appendMessage(text, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.id = 'msg-' + Date.now();
        div.innerHTML = text; 
        document.getElementById('chat-container').appendChild(div);
        const container = document.getElementById('chat-container');
        container.scrollTop = container.scrollHeight;
        return div.id;
    }

    document.getElementById('user-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
</script>
</body>
</html>
